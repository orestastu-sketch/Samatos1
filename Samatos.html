<!DOCTYPE html>
<html lang="lt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kainų Sąmatos Generatorius</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            padding: 20px;
        }
        .container {
            max-width: 1100px;
            margin: 0 auto;
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }
        .loading-ring {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }
        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Pataisymas: įvesties laukas, kad skaičiai būtų aiškiai juodi */
        .price-input-field {
            color: #1f2937; /* Dark gray/black text */
            text-align: right;
            font-weight: 600;
        }

        /* Mobile optimization */
        @media (max-width: 640px) {
            .container {
                padding: 1rem;
            }
            .table th, .table td {
                padding: 8px 4px;
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body>

<div id="app" class="container">
    <h1 class="text-3xl font-extrabold text-gray-800 mb-6 border-b pb-2">Prekių Kainų Sąmatos Įrankis (HIBRIDINĖ VERSJJA)</h1>
    <div class="p-3 mb-6 bg-yellow-100 border border-yellow-400 text-yellow-700 rounded-lg">
        **DĖMESIO:** Programėlė veikia **Hibridiniu Režimu**. Duomenys simuliuojami, bet pridėta rankinė kainos įvestis ir tikslios paieškos nuorodos.
    </div>

    <div class="mb-6">
        <label for="productModels" class="block text-sm font-medium text-gray-700 mb-2">Prekių Modeliai (po vieną eilutėje):</label>
        <textarea id="productModels" rows="6" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150" placeholder="Įveskite, pvz.:&#10;Dell XPS 13 (2024)&#10;Nvidia GeForce RTX 4080&#10;Samsung S24 Ultra 256GB"></textarea>
    </div>

    <div class="flex flex-col sm:flex-row gap-4 mb-8">
        <button id="findPricesBtn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out disabled:opacity-50">
            <span id="buttonText">Simuliuoti Sąmatą ir Generuoti Paieškos Nuorodas</span>
            <span id="loadingSpinner" class="loading-ring hidden ml-2"></span>
        </button>

        <button id="downloadCsvBtn" disabled class="flex-1 bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out disabled:opacity-50">
            Atsisiųsti Sąmatą (CSV)
        </button>
        
        <button id="showCsvBtn" disabled class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out disabled:opacity-50">
            Rodyti CSV tekstą (Kopijuoti)
        </button>
    </div>

    <!-- Results Table -->
    <h2 class="text-xl font-bold text-gray-800 mt-8 mb-4">Rezultatai:</h2>
    <div id="resultsMessage" class="text-center text-gray-500 italic p-4 border border-dashed rounded-lg bg-gray-50">
        Pradėkite įvesdami prekių modelius ir paspausdami mygtuką.
    </div>
    
    <div id="resultsContainer" class="overflow-x-auto hidden">
        <table class="min-w-full divide-y divide-gray-200 shadow-sm rounded-lg table">
            <thead class="bg-gray-50">
                <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/5">Prekės Modelis</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-2/5">Informacija / Simuliuota Kaina</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/5">Įvesta Kaina</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/5">Tiesioginė Paieška</th>
                </tr>
            </thead>
            <tbody id="resultsTableBody" class="bg-white divide-y divide-gray-200">
                <!-- Results will be inserted here -->
            </tbody>
        </table>
    </div>

    <!-- Custom Modals (Error, CSV) remain the same -->
    <div id="errorModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full">
            <div class="flex justify-between items-start">
                <h3 class="text-lg font-bold text-red-600">Klaida</h3>
                <button onclick="document.getElementById('errorModal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <p id="errorModalMessage" class="mt-4 text-sm text-gray-700"></p>
            <div class="mt-6 flex justify-end">
                <button onclick="document.getElementById('errorModal').classList.add('hidden')" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg">Uždaryti</button>
            </div>
        </div>
    </div>
    
    <div id="csvModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-2xl w-full">
            <div class="flex justify-between items-start mb-4">
                <h3 class="text-xl font-bold text-gray-800">Sąmatos Tekstas (CSV)</h3>
                <button onclick="document.getElementById('csvModal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <p class="text-sm text-gray-600 mb-3">Nukopijuokite žemiau esantį tekstą ir įklijuokite jį į tekstinį failą (.txt), kurį galėsite importuoti į „Excel“ arba „Google Sheets“ (atskirtas kabliataškiu **;**).</p>
            <textarea id="csvContent" rows="10" readonly class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50 font-mono text-sm"></textarea>
            <div class="mt-4 flex justify-end gap-3">
                <button id="copyCsvBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-300">
                    Kopijuoti Tekstą
                </button>
                <button onclick="document.getElementById('csvModal').classList.add('hidden')" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg">
                    Uždaryti
                </button>
            </div>
        </div>
    </div>
</div>

<script type="module">
    // --- Pastaba: Ši versija veikia SIMULIACIJOS režimu, API nenaudojama ---

    // UI Elements
    const modelsTextarea = document.getElementById('productModels');
    const findPricesBtn = document.getElementById('findPricesBtn');
    const downloadCsvBtn = document.getElementById('downloadCsvBtn');
    const showCsvBtn = document.getElementById('showCsvBtn'); 
    const resultsTableBody = document.getElementById('resultsTableBody');
    const resultsContainer = document.getElementById('resultsContainer');
    const resultsMessage = document.getElementById('resultsMessage');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const buttonText = document.getElementById('buttonText');
    const errorModal = document.getElementById('errorModal');
    const errorModalMessage = document.getElementById('errorModalMessage');
    const csvModal = document.getElementById('csvModal'); 
    const csvContent = document.getElementById('csvContent'); 
    const copyCsvBtn = document.getElementById('copyCsvBtn'); 

    // State
    /** @type {Array<{model: string, summary: string, searchUrl: string, manualPrice: number | null}>} */
    let searchResults = [];

    // --- Utility Functions ---

    /**
     * Shows a custom error modal instead of alert().
     * @param {string} message The error message to display.
     */
    function showCustomError(message) {
        errorModalMessage.textContent = message;
        errorModal.classList.remove('hidden');
    }

    /**
     * Handles the display of loading state.
     * @param {boolean} isLoading True to show loading state, false to hide.
     */
    function setLoading(isLoading) {
        findPricesBtn.disabled = isLoading;
        const hasResults = searchResults.length > 0;
        downloadCsvBtn.disabled = isLoading || !hasResults;
        showCsvBtn.disabled = isLoading || !hasResults; 
        
        if (isLoading) {
            loadingSpinner.classList.remove('hidden');
            buttonText.textContent = 'Simuliuojama...';
        } else {
            loadingSpinner.classList.add('hidden');
            buttonText.textContent = 'Simuliuoti Sąmatą ir Generuoti Paieškos Nuorodas';
            
            if (hasResults) {
                resultsContainer.classList.remove('hidden');
                resultsMessage.classList.add('hidden');
            } else {
                resultsContainer.classList.add('hidden');
                resultsMessage.classList.remove('hidden');
                resultsMessage.textContent = 'Nerasta jokių rezultatų. Įveskite prekių modelius.';
            }
        }
    }

    /**
     * Generates a broad Google search URL for the given model.
     * @param {string} model The product model.
     * @param {string} siteTarget Optional site (e.g., 'bkgrupe.lt'). If present, adds 'site:' prefix.
     * @returns {string} The encoded Google search URL.
     */
    function generateGoogleSearchUrl(model, siteTarget = '') {
        // Paieškos užklausa dabar naudoja TIK modelį. Jei nurodytas puslapis, pridedamas "site:" operatorius.
        let query = model.trim(); 
        if (siteTarget) {
            // Į paiešką keliauja ir modelis, ir "site:" operatorius.
            query = `site:${siteTarget} ${query}`;
        }
        return `https://www.google.com/search?q=${encodeURIComponent(query)}`;
    }


    // Attach to window so it can be called directly from oninput attribute
    window.updateManualPrice = function(inputElement) {
        const index = parseInt(inputElement.getAttribute('data-index'), 10);
        
        // Pataisyta: Išvalomas bet koks ne skaičius, bet paliekamas kablelis ar taškas.
        const cleanedValue = inputElement.value.replace(',', '.'); 
        const value = parseFloat(cleanedValue);

        if (index >= 0 && index < searchResults.length) {
            // Save as number or null if input is empty/invalid
            searchResults[index].manualPrice = isNaN(value) ? null : value;
            // Įvesties laukelio vertė atnaujinama, kad atspindėtų skaitmeninę vertę, bet paliekamas ir tuščias laukas, jei įvestis invalidi.
            // Pakeista į "text" input type, kad būtų galima įvesti ir kablelį, ir tašką.
            inputElement.value = inputElement.value.replace(',', '.');
        }
    };


    /**
     * Converts the searchResults array to a CSV string.
     * @param {Array<Object>} data The data array.
     * @returns {string} The CSV formatted string.
     */
    function convertToCSV(data) {
        try {
            const separator = ';'; 
            const BOM = "\uFEFF"; 
            
            // Pakeista: "Įvesta Kaina (EUR)" į "Įvesta Kaina (EUR)"
            const header = ["Prekės Modelis", "Informacija", "Įvesta Kaina (EUR)", "Google Paieškos Nuoroda"];
            
            const rows = data.map(row => {
                const escapeField = (field) => {
                    if (typeof field !== 'string') field = String(field);
                    // Pašalinta SIMULIUOTA:
                    const cleanedField = field.replace(/SIMULIUOTA:/gi, '').replace(/(\r\n|\n|\r)/gm, " ").trim();
                    return `"${cleanedField.replace(/"/g, '""')}"`;
                };
                
                const escapedModel = escapeField(row.model || '');
                const escapedSummary = escapeField(row.summary || '');
                // Escape the manual price, formatting to 2 decimal places if present (naudojamas kablelis, kaip labiau įprasta Lietuvoje)
                const priceValue = row.manualPrice !== null ? row.manualPrice.toFixed(2).replace('.', ',') : '';
                const escapedManualPrice = escapeField(priceValue); 
                const escapedSearchUrl = escapeField(row.searchUrl || ''); 
                
                // Return row with the new price field
                return [escapedModel, escapedSummary, escapedManualPrice, escapedSearchUrl].join(separator);
            });
            
            return BOM + [header.join(separator), ...rows].join('\n');
        } catch (error) {
            console.error("Klaida generuojant CSV:", error);
            showCustomError(`Nepavyko sugeneruoti CSV failo: ${error.message}. Bandykite nukopijuoti tekstą.`);
            return "";
        }
    }

    /**
     * Downloads a file with the given content and filename.
     * @param {string} content The file content (CSV string).
     * @param {string} filename The name of the file.
     * @param {string} contentType The file MIME type.
     */
    function downloadFile(content, filename, contentType) {
        if (!content) return;

        const blob = new Blob([content], { type: contentType });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        
        URL.revokeObjectURL(url);
    }
    
    // --- **SIMULIACIJA**: Bypassing Gemini API ---

    /**
     * Simulates fetching price and summary information using hardcoded data.
     * @param {string} model The product model to search for.
     * @returns {Promise<Object>} An object containing model, summary, and searchUrl.
     */
    async function findPriceAndSummary(model) {
        // Simulate network latency (500ms - 1500ms)
        const delay = Math.random() * 1000 + 500;
        await new Promise(resolve => setTimeout(resolve, delay)); 
        
        const normalizedModel = model.trim().toUpperCase();
        // Naudojama bendra paieška, be jokio siteTarget
        const searchUrl = generateGoogleSearchUrl(model, ''); 
        
        let summary;

        // Visi simuliacijos tekstai prasideda nuo "SIMULIUOTA:"
        if (normalizedModel.includes('DS-7608NXI-K1/8P')) {
            summary = 'SIMULIUOTA: Profesionalus Hikvision 8 kanalų NVR įrašymo įrenginys su 8 PoE prievadais ir AcuSense technologija. Simuliuojama kaina: **450 EUR - 550 EUR**.';
        } else if (normalizedModel.includes('IPHONE 15 PRO')) {
            summary = 'SIMULIUOTA: Naujausias Apple flagmanas su titano korpusu ir A17 Bionic lustu. Simuliuojama kaina: nuo **1200 EUR** (128GB).';
        } else if (normalizedModel.includes('NVIDIA GEFORCE RTX 4080')) {
            summary = 'SIMULIUOTA: Aukštos klasės vaizdo plokštė, skirta 4K žaidimams. Simuliuojama kaina: **1100 EUR - 1300 EUR** (Mock data).';
        } else if (normalizedModel.includes('DELL XPS 13')) {
            summary = 'SIMULIUOTA: Plonas ir lengvas nešiojamas kompiuteris su 13.4 colio InfinityEdge ekranu. Simuliuojama kaina: nuo **1350 EUR**.';
        } else if (normalizedModel.includes('SAMSUNG S24 ULTRA')) {
            summary = 'SIMULIUOTA: Geriausias Samsung modelis, 6.8 colio Dynamic AMOLED 2x ekranas. Simuliuojama kaina: nuo **1499 EUR**.';
        } else {
            summary = 'SIMULIUOTA: Nepavyko rasti jokios informacijos apie šį modelį vietinėje duomenų bazėje. Naudokite paieškos mygtukus, kad rastumėte realius duomenis.';
        }

        return {
            model: model.trim(),
            summary: summary,
            searchUrl: searchUrl,
            manualPrice: null // Initial value for manual price
        };
    }

    /**
     * Processes all product models and updates the UI.
     */
    async function processModels() {
        const models = modelsTextarea.value
            .split('\n')
            .map(m => m.trim())
            .filter(m => m.length > 0);

        if (models.length === 0) {
            showCustomError('Įveskite bent vieną prekės modelį, kad galėtumėte ieškoti.');
            return;
        }

        resultsTableBody.innerHTML = '';
        searchResults = [];
        setLoading(true);

        resultsMessage.classList.remove('hidden');
        resultsMessage.innerHTML = `<div class="loading-ring mr-2"></div> Pradedama **SIMULIUOTA** sąmatos generacija...`;
        resultsContainer.classList.add('hidden');


        for (const model of models) {
            resultsMessage.innerHTML = `<div class="loading-ring mr-2"></div> Simuliuojama: <strong>${model}</strong>...`;

            const result = await findPriceAndSummary(model);
            searchResults.push(result);
            
            // Re-render only after a new result is added
            renderResults(); 
        }

        setLoading(false);
        resultsMessage.textContent = `**SIMULIUOTA** sąmatos generacija baigta. Rasta ${searchResults.length} rezultatai. Įveskite kainas ir naudokite paieškos nuorodas.`;
    }

    /**
     * Renders the current searchResults array to the HTML table.
     */
    function renderResults() {
        // NOTE: Optimization - only clear and re-render the necessary parts if performance is an issue.
        // For simplicity, we clear and re-render the whole body on each loop iteration.
        resultsTableBody.innerHTML = ''; 

        searchResults.forEach((item, index) => {
            const row = resultsTableBody.insertRow();
            // Highlight simulation warning rows yellow
            if (item.summary.includes('Nepavyko rasti jokios informacijos')) {
                row.classList.add('bg-yellow-100');
            } else {
                row.classList.add('hover:bg-gray-100', 'transition', 'duration-150');
            }

            // 1. Model Cell
            const modelCell = row.insertCell();
            modelCell.className = 'px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900';
            modelCell.textContent = item.model;

            // 2. Summary Cell
            const summaryCell = row.insertCell();
            summaryCell.className = 'px-6 py-4 whitespace-pre-wrap text-sm text-gray-700';
            summaryCell.innerHTML = item.summary.replace('SIMULIUOTA:', '<span class="font-bold text-gray-600">SIMULIUOTA:</span>'); 

            // 3. Manual Price Input Cell (PATAISYTA EUR VIETA)
            const priceInputCell = row.insertCell();
            priceInputCell.className = 'px-6 py-4 whitespace-nowrap text-sm';
            
            // Vertė gali būti su kableliu, todėl naudojama replace('.', ',') atvaizdavimui
            const displayValue = item.manualPrice !== null ? String(item.manualPrice).replace('.', ',') : '';
            priceInputCell.innerHTML = `
                <div class="flex items-center space-x-2">
                    <input 
                        type="text" 
                        inputmode="decimal"
                        data-index="${index}" 
                        value="${displayValue}"
                        placeholder="0,00"
                        oninput="window.updateManualPrice(this)"
                        class="price-input-field w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150"
                    />
                    <span class="text-gray-700 font-semibold text-sm">EUR</span>
                </div>
            `;


            // 4. Search Links Cell (PATAISYTA: TIK MODELIS PAIEŠKAI)
            const searchCell = row.insertCell();
            searchCell.className = 'px-6 py-4 whitespace-nowrap text-sm space-y-1 flex flex-col items-start';
            
            // Google Search Icon SVG (reused for all links)
            const searchIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 mr-1"><path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.394l3.743 3.744a1 1 0 01-1.414 1.414l-3.744-3.743A7 7 0 012 9z" clip-rule="evenodd" /></svg>`;

            searchCell.innerHTML = `
                <a href="${generateGoogleSearchUrl(item.model)}" target="_blank" class="inline-flex items-center justify-center px-2 py-1 border border-transparent text-xs font-medium rounded-md shadow-sm text-white bg-red-500 hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150 ease-in-out w-full">
                    ${searchIcon}
                    Google (Modelis)
                </a>
                <a href="${generateGoogleSearchUrl(item.model, 'bkgrupe.lt')}" target="_blank" class="inline-flex items-center justify-center px-2 py-1 border border-transparent text-xs font-medium rounded-md shadow-sm text-white bg-indigo-500 hover:bg-indigo-600 transition duration-150 ease-in-out w-full">
                    ${searchIcon}
                    Google bkgrupe.lt
                </a>
                <a href="${generateGoogleSearchUrl(item.model, 'kaina24.lt')}" target="_blank" class="inline-flex items-center justify-center px-2 py-1 border border-transparent text-xs font-medium rounded-md shadow-sm text-white bg-indigo-500 hover:bg-indigo-600 transition duration-150 ease-in-out w-full">
                    ${searchIcon}
                    Google kaina24.lt
                </a>
            `;
        });
        
        if (searchResults.length > 0) {
            resultsContainer.classList.remove('hidden');
        }

        downloadCsvBtn.disabled = searchResults.length === 0;
        showCsvBtn.disabled = searchResults.length === 0;
    }

    // --- Event Listeners ---
    findPricesBtn.addEventListener('click', processModels);
    
    // 1. Automatic Download
    downloadCsvBtn.addEventListener('click', () => {
        if (searchResults.length > 0) {
            const csv = convertToCSV(searchResults);
            if (csv) {
                const date = new Date().toISOString().slice(0, 10);
                downloadFile(csv, `samata_simuliacija_${date}.csv`, 'text/csv;charset=utf-8;');
            }
        } else {
            showCustomError('Nėra rezultatų atsisiuntimui.');
        }
    });
    
    // 2. CSV Text Fallback
    showCsvBtn.addEventListener('click', () => {
        if (searchResults.length > 0) {
            const csv = convertToCSV(searchResults);
            if (csv) {
                csvContent.value = csv;
                csvModal.classList.remove('hidden');
                csvContent.select(); 
            }
        } else {
            showCustomError('Nėra rezultatų rodymui.');
        }
    });

    // Copy CSV Text Logic
    copyCsvBtn.addEventListener('click', () => {
        csvContent.select();
        try {
            document.execCommand('copy');
            copyCsvBtn.textContent = 'Nukopijuota!';
            setTimeout(() => {
                copyCsvBtn.textContent = 'Kopijuoti Tekstą';
            }, 1500);
        } catch (err) {
            showCustomError('Klaida kopijuojant: Jūsų naršyklė nepalaiko automatinio kopijavimo.');
        }
    });

    // Initial state setup
    function initializeApp() {
        setLoading(false);
        modelsTextarea.value = "DS-7608NXI-K1/8P\nApple iPhone 15 Pro\nDell XPS 13 (2024 model)\nNežinomas Modelis";
    }

    initializeApp();
</script>

</body>
</html>

